---
title: "Bivand_Wong_2018_Notes"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set up reticulate environment
library(reticulate)
# Download necessary packages - uncomment as needed 
# if following chunks fail to run
# py_install("pandas")
```

# Introduction

Core objective of the article: assess different software implementations for global and local indicators of spatial association. Understand how the default settings across software may impact the analyst's takeaways.

Two core areas of focus: spatial heterogeneity, spatial autocorrelation.

Data for case study: eires of Ireland. Let's load the data and perform a simple Moran's I calculation using Binary weights and not using randomization for inference 

```{r}

eire <- rgdal::readOGR(system.file("shapes/eire.shp", package = "spData")[1])

library(spdep)

eire.nb <- poly2nb(eire)

moran.test(eire$OWNCONS, nb2listw(eire.nb, style = "B"), randomisation = FALSE)

```

```{r}
# Alter some of the spatial weights to draw comparison to Cliff and Ord 1969

eire.nb[[3]] <- sort(c(eire.nb[[3]], 8L))
eire.nb[[8]] <- sort(c(eire.nb[[8]], 3L))

moran.test(eire$OWNCONS, nb2listw(eire.nb, style = "B"), randomisation = FALSE)
```

Bivand and Wong (hereafter BW) note that in the above case of the Moran's I shift from 0.71 to 0.62 is due to a missing link in the graph of neighbors. However, the question remains **why do some users still receive different results when comparing identical datasets and neighbor graphs?** BW spend the rest of article understanding these differences.

## Global and local indicators

"Global measures express the strength of spatial autocorrelation present in the quantitative variable of interest across a whole areal data set, possibly after considering the influence of other variables."

We recall that the strength of spatial autocorrelation may vary if the spatial weights matrix is defined in a different way.

"Local measures decompose the spatial autocorrelation present in the quantitative variable of interest across an areal data set to each of the component areas, also using a fixed spatial weights matrix chosen by the analyst. They will be affected by missing consideration of other variables, and/or of a global spatial process."

### Global indicators - Moran's i

Moran's I equation from Cliff and Ord 1981

$$ I = \frac{n \sum w_{ij} z_i z_j}{S_0 \sum z^2_i} $$
Expectation of Moran's I:

$$ E(I) = - \frac{1}{(n-1)} $$

Interestingly, BW explain how 'it is not obvious whether Cliff and Ord (1969) intended n to be the number of observations in total, or the number of observations with neighbors [for inference]'. In `spdep`, global measures by default adjust nt to the number of observations with neighbors once the user has chosen to permit observations with no neighbors. This specification results in:

$$ n' = \sum [ \sum w_{ij} >0 ] $$

Although it is more involved, we ultimatley reach the standard normal deviate under one of the assumptions for evaluations:

$$ Z_* (I) = \frac{I - E(I)}{\sqrt{Var_* (I)}} $$

### Global indicators - Geary's C

Although applied less than Moran's I, Geary's C another popular choice of global autocorrelation. 

$$ C = (\frac{(n-1)}{2S_0}) * \frac{\sum w_{ij}(x_i - x_j)^2}{\sum z^2_i} $$

With an expectation of $E(C) = 1$.

A slightly revised normal deviate:

$$ Z(C) = \frac{E(C) - C}{\sqrt{Var_* (C)}} $$

### Getis-Ord G

Lastly, Getis-Ord global G. Drops the explicit $d()$ term. 

$$ G = \frac{\sum w_{ij} x_i x_j}{\sum x_i x_j} $$

Expectation:

$$ E(G) = \frac{S_0}{n(n-1)} $$

Standard normal deviate:

$$ Z(G) = \frac{G - E(G)}{\sqrt{Var(G)}} $$
**Another section follows with more equations for the local versions of each of the above statistics, but they are excluded for brevity.**

# Software implementations

BW note the numerous implementations of local and global measures autocorrelation:

- Crimestat
- ArcGIS
- GeoDa
- PySAL
- R:spdep

See BW2018 pg 11 for specific details as to how each of these software handle spatial weights and/or connectivity differently. Here we will only focus on the `R:spdep` and `PySAL` implementations. 

# End points

- Differences in global measures less numerically obvious
- Differences in local measures important and likely to impact conclusions drawn. Authors point to `spdep` saddlepoint approximation of exact methods ofr local Moran's I_i in order to remove global mis-specification from the data
- BW worried that spatial patterns of Z values generated by conditional permutation for local measures differ considerably from those calculated using analytical methods 
- Perhaps divergence between analytical and conditional permutations is driven by local spatial heterogeneity